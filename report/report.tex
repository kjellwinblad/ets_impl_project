%\documentclass[aps,pre,preprint,groupedaddress,nofootinbib]{revtex4}
\documentclass[aps,pre,preprint,nofootinbib]{revtex4}
%\documentclass[aps,twocolumn,pre,nofootinbib]{revtex4}   % list options between brackets
\usepackage{}              % list packages between braces

% type user-defined commands here

\begin{document}

\title{Erlang Term Storage Implementation}
\author{Kjell Winblad and Stavros Aronis}
\date{\today}


\begin{abstract}

  This report describe in detail how the Erlang Term Storage (ETS) is implemented.
  The report is created in the RELEASE project as the first step towards creating a more scalable ETS implementation.
  ETS tables are commonly used to share data between processes in Erlang programs.
  It is important to have a very good ETS implementation because shared data is often the bottleneck in concurrent applications.
  The main goals of the report are:
  \begin{itemize}
   \item to get an understanding of the current implementation of the different ETS tables
   \item and to communicate this knowledge to for example the Erlang OTP team. 
  \end{itemize}

\end{abstract}

\maketitle

\section{Introduction}

Erlang Term Storage (ETS) tables is a part of Erlang standard library. 
The ETS tables are used as a way to efficiently share data between processes. 
An Erlang ETS table share many properties with ordinary Erlang processes. 
The programmer can manage ETS tables by a set of built-in functions (BIFs). 
The BIFs are implemented in the C programming language and they are a part of Erlang standard library.
An ETS table is identified by an identifier.
The identifier for a table is created with the BIF \verb|ets:new|.
The \verb|ets:new| BIF can take a list of options that can be used to specify: 

\begin{itemize}
 \item 
 If the table type shall be \verb|set|, \verb|bag |, \verb|duplicate_bag| or \verb|ordered_set|. 
 See section~\ref{sec:table_types} for information about the data-structures used in the different table types.
 \item 
 The access level which can be \verb|private|, \verb|protected| and \verb|public|.
 See the Erlang documentation for \verb|ets:new| for more information about these options.
 \item 
 If fine grained locking shall be enabled for read and write can be specified with the options \verb|write_concurrency| and \verb|read_concurrency|. 
 These options may have a large impact on scalability for some applications.
 See section~\ref{sec:concurrency_options} and \ref{sec:benchmark} for more information about these options.
\end{itemize}

All ETS tables are owned by the creating process as long as the creating process is alive and has not given the ownership to an other process with the BIF \verb|ets:give_away|.
If the owner of an ETS table died the table will be deleted, if not the \verb|heir| option is set.
The programmer can use the \verb|heir| option to specify a process that will inherit the table when it dies. 
If a process has been specified with the \verb|heir| option it will get a message from the previous owner when the previous owner dies.

\subsection{Overview of Table Operations}

This section gives an overview of the most fundamental ETS table operations. 
See the Erlang documentation for ETS tables for a complete description of all table operations. 
See section~\ref{sec:table_types} for information about the data-structures used in the tables.

\begin{description}
 \item[lookup(Tab, Key) $\rightarrow$ [Object]] 
 Returns a list of elements with the given key. 
 Calls to \verb|lookup| and \verb|insert| can be done concurrently if \verb|read_concurrency| is activated when \verb|set|, \verb|bag | or \verb|duplicate_bag| is used.
 \item[insert(Tab, ObjectOrObjects) $\rightarrow$ true]
 Insert the given object or objects in case the parameter is a list of objects.
 Several inserts can be done concurrently if \verb|write_concurrency| is activated when \verb|set|, \verb|bag | or \verb|duplicate_bag| is used.
 \item[insert\_new(Tab, ObjectOrObjects) $\rightarrow$ true]
 This operation will insert the given object or objects if no object with the same key as any of the object(s) exists. 
 If a key already exists the operation will return false.
\end{description}


\section{Handling of Tables}

The infrastructure for the handling of tables is described in this section. 
An overview of the data-structures involved is provided in section~\ref{sec:tables_overview}.
How locking is done when tables are accessed concurrently is described in section~\ref{sec:tables_locking}.

\subsection{Overview} \label{sec:tables_overview}


\subsubsection{Global data structures}


\begin{description}
  \item[meta\_main\_table] Contains all the tables. TIDs map to a slot.
  \item[meta\_main\_table] The meta table can contain a maximum of 2053 tables. 
  This maximum can be changed by the setting the  environment variable \verb|DB_DEF_MAX_TABS|.
  The size is fixed during the liftime of the Erlang VM.
  \item[meta\_name\_table] Keys are atoms, values are TIDs.
  \item[meta\_pid\_to\_tab] Maps processes (PIDs) to tables owned by them.
  \item[meta\_pid\_to\_fixed\_tab] Maps processes (PIDs) to tables that are
    fixated by them.
\end{description}

\subsection{Locking} \label{sec:tables_locking}


\section{Table Types} \label{sec:table_types}

\subsection{Set}     % section 2.1
\subsubsection{Data Structure}
\subsubsection{Expanding}
\subsubsection{Shrinking}

\subsection{Bag}
\subsection{Duplicate Bag}
\subsection{Ordered Set}


\section{Concurrency Options} \label{sec:concurrency_options}

\subsection{Write Concurrency}

\subsection{Read Concurrency}


\section{Benchmark} \label{sec:benchmark}

\subsection{Description}

\subsection{Results}


\section{Scalable ETS Suggestions}

\begin{thebibliography}{9}
  % type bibliography here
\end{thebibliography}

\end{document}
